package com.example.shortenerxml // Kendi paket adınla değiştir

import android.content.ClipData
import android.content.ClipboardManager
import android.content.Context
import android.content.Intent
import android.net.Uri
import android.os.Bundle
import android.widget.Button
import android.widget.EditText
import android.widget.Toast
import androidx.appcompat.app.AppCompatActivity
import androidx.lifecycle.lifecycleScope
import androidx.room.Room
import kotlinx.coroutines.launch
import java.util.UUID

class MainActivity : AppCompatActivity() {

    private lateinit var db: AppDatabase

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        // Veritabanı Kurulumu
        db = Room.databaseBuilder(
            applicationContext,
            AppDatabase::class.java,
            "url-shortener-db"
        ).build()

        // Deep Link Kontrolü (Uygulama link ile mi açıldı?)
        handleDeepLink()

        // --- UI Tanımlamaları ---
        val etLong = findViewById<EditText>(R.id.etLongUrl)
        val etShort = findViewById<EditText>(R.id.etShortUrl)
        val btnShorten = findViewById<Button>(R.id.btnShorten)
        val btnCopy = findViewById<Button>(R.id.btnCopy) // Artık normal Button

        // --- 1. BUTON: Kısaltma İşlemi ---
        btnShorten.setOnClickListener {
            val longUrl = etLong.text.toString()

            if (longUrl.isNotEmpty()) {
                val code = UUID.randomUUID().toString().take(6)
                val shortLink = "https://kisa.link/$code"

                // Veritabanına Yaz
                lifecycleScope.launch {
                    db.linkDao().insert(Link(longUrl = longUrl, shortCode = code))
                    
                    // Ekrana Yaz
                    etShort.setText(shortLink)
                    Toast.makeText(this@MainActivity, "Link oluşturuldu!", Toast.LENGTH_SHORT).show()
                }
            } else {
                Toast.makeText(this, "Lütfen bir URL girin", Toast.LENGTH_SHORT).show()
            }
        }

        // --- 2. BUTON: Kopyalama İşlemi ---
        btnCopy.setOnClickListener {
            val textToCopy = etShort.text.toString()
            
            if (textToCopy.isNotEmpty()) {
                val clipboard = getSystemService(Context.CLIPBOARD_SERVICE) as ClipboardManager
                val clip = ClipData.newPlainText("Short URL", textToCopy)
                clipboard.setPrimaryClip(clip)
                
                Toast.makeText(this, "Panoya kopyalandı", Toast.LENGTH_SHORT).show()
            } else {
                Toast.makeText(this, "Kopyalanacak link yok", Toast.LENGTH_SHORT).show()
            }
        }
    }

    // Link Yönlendirme Mantığı
    private fun handleDeepLink() {
        val action: String? = intent?.action
        val data: Uri? = intent?.data

        if (Intent.ACTION_VIEW == action && data != null) {
            val code = data.lastPathSegment

            if (code != null) {
                lifecycleScope.launch {
                    val linkObj = db.linkDao().getLinkByCode(code)
                    if (linkObj != null) {
                        val browserIntent = Intent(Intent.ACTION_VIEW, Uri.parse(linkObj.longUrl))
                        startActivity(browserIntent)
                        finish()
                    } else {
                        Toast.makeText(this@MainActivity, "Link bulunamadı!", Toast.LENGTH_LONG).show()
                    }
                }
            }
        }
    }
}